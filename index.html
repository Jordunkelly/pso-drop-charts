<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PSO-BB Brotherhood Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { 
            --bg: #0d1117; --panel: #161b22; --border: #30363d; --text: #c9d1d9; 
            --blue: #58a6ff; --gold: #d4af37; --uber: #ff79c6; --god: #ffb86c; --support: #50fa7b;
            --mag-color: #ff7b72; --green: #2ea043;
        }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; transition: background-color 0.5s; overflow-x: hidden; }
        
        /* --- NAVIGATION --- */
        .main-nav { background: #010409; border-bottom: 1px solid var(--border); display: flex; padding: 10px 20px; gap: 20px; position: sticky; top: 0; z-index: 2000; align-items: center; }
        .nav-tab { padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.2s; color: var(--text); }
        .nav-tab.active { background: var(--blue); color: white; }
        .class-selector-wrapper { margin-left: auto; display: flex; align-items: center; gap: 10px; }

        .content-section { padding: 20px; display: none; }
        .content-section.active { display: block; }

        /* --- STICKY CONTROLS --- */
        .controls { 
            background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid var(--border); 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;
            position: sticky; top: 60px; z-index: 1500;
        }
        input, select { width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; }

        /* --- TABLE & BADGES --- */
        table { width: 100%; border-collapse: collapse; background: var(--panel); border-radius: 8px; }
        th { background: #21262d; color: var(--blue); padding: 12px; text-align: left; font-size: 0.8em; position: sticky; top: 225px; z-index: 1000; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9em; position: relative; }
        
        .item-wrapper { position: relative; display: inline-block; }
        .item-name-text { cursor: pointer; color: white; font-weight: bold; border-bottom: 1px dashed var(--blue); }
        .hover-window {
            display: none; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            width: 280px; background: #1c2128; border: 1px solid var(--gold); border-radius: 8px;
            padding: 15px; z-index: 3000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); pointer-events: auto;
        }
        .item-wrapper:hover .hover-window { display: block; }
        
        .tier-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: bold; margin-left: 8px; text-transform: uppercase; }
        .tier-UBER { background: var(--uber); color: black; box-shadow: 0 0 5px var(--uber); }
        .tier-SPLUS { background: var(--god); color: black; box-shadow: 0 0 5px var(--god); }
        .tier-S { background: var(--gold); color: black; }
        .tier-A { background: var(--blue); color: white; }
        .class-val-badge { border: 1px solid var(--text); color: var(--text); font-size: 0.65em; padding: 1px 4px; border-radius: 3px; margin-left: 5px; }

        /* Hover Window Buttons */
        .rel-btn { display: block; margin-top: 10px; background: #238636; color: white; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: bold; text-align: center; }
        .wiki-btn { display: block; margin-top: 5px; background: var(--blue); color: white; padding: 8px; border-radius: 4px; text-decoration: none; font-size: 0.85em; font-weight: bold; text-align: center; }

        /* --- MAG TIMER ANIMATIONS --- */
        .mag-layout { display: flex; justify-content: center; align-items: flex-start; gap: 40px; margin-top: 50px; }
        .timer-card { background: var(--panel); padding: 2.5rem; border-radius: 20px; border: 2px solid var(--border); text-align: center; width: 360px; position: relative; transition: all 0.5s; box-shadow: 0 15px 40px rgba(0,0,0,0.7); }
        
        .mag-container { height: 120px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; position: relative; overflow: hidden; border-radius: 10px; }
        .mag { width: 60px; height: 60px; background: var(--mag-color); border-radius: 15px; position: relative; z-index: 2; animation: float 3s ease-in-out infinite; box-shadow: inset -5px -5px 0 rgba(0,0,0,0.2); }
        .mag::before, .mag::after { content: ''; position: absolute; top: 25px; width: 100%; height: 2px; background: #000; width: 10px; }
        .mag::before { left: 12px; } .mag::after { right: 12px; }

        .scenery { display: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; }
        .sun { width: 30px; height: 30px; background: #ffdf5d; border-radius: 50%; position: absolute; top: 10px; right: 20px; box-shadow: 0 0 10px #ffdf5d; }
        .grass { position: absolute; bottom: 0; width: 100%; height: 20px; background: var(--green); }
        .tree { position: absolute; bottom: 20px; left: 20px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid #1b4d2e; }
        
        .zzz { position: absolute; right: 80px; top: 20px; opacity: 0; animation: zzz-fly 4s linear infinite; color: var(--blue); font-weight: bold; }
        
        .walking .scenery { display: block; }
        .walking .mag { animation: walk 1s ease-in-out infinite; background: #88ccff; }
        .excited .mag { background: var(--gold); animation: bounce 0.5s infinite; }
        .excited .mag::before, .excited .mag::after { content: ''; background: none; color: #ff7b72; font-size: 14px; top: 15px; height: auto; }
        
        .break-active { background-color: #061e0b !important; }
        .break-card { border-color: var(--green) !important; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes walk { 0%, 100% { transform: translateX(-5px) rotate(-5deg); } 50% { transform: translateX(5px) rotate(5deg); } }
        @keyframes zzz-fly { 0% { opacity: 0; transform: translate(0,0); } 30% { opacity: 1; } 100% { opacity: 0; transform: translate(30px, -40px); } }
        
        #timer-display { font-size: 4.5rem; font-weight: bold; font-family: 'Courier New', monospace; margin: 10px 0; }
        
        .tag { padding: 2px 8px; border-radius: 4px; font-weight: bold; color: #fff; font-size: 0.8em; background: #30363d; }
    
		/* Rare Enemy Badge Style */
		.rare-badge {
			background: #a855f7; /* Purple */
			color: #fff;
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 0.7em;
			font-weight: bold;
			margin-left: 8px;
			box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
			text-transform: uppercase;
		}

		/* Optional: Subtle row highlight for rare enemies */
		.row-rare {
			background-color: rgba(168, 85, 247, 0.05) !important;
		}
	</style>
</head>
<body>

<nav class="main-nav">
    <div class="nav-tab active" onclick="switchTab('drop-tool')">Drop Charts</div>
    <div class="nav-tab" onclick="switchTab('mag-tool')">Mag Tool</div>
    <div class="class-selector-wrapper">
        <label style="font-size: 0.8em; font-weight: bold;">VIEW AS:</label>
        <select id="globalClassSelector" onchange="applyFilters()" style="width: 140px; padding: 5px;">
            <option value="HUNTER">HUNTER</option>
            <option value="RANGER">RANGER</option>
            <option value="FORCE">FORCE</option>
        </select>
    </div>
</nav>

<div id="drop-tool" class="content-section active">
    <div class="controls">
        <input type="text" id="nameSearch" class="full-width" placeholder="Search Item Name (e.g., Red Ring)...">
        <select id="tierFilter">
            <option value="">All Global Tiers</option>
            <option value="UBER">UBER (Units)</option>
            <option value="SPLUS">S+ Tier</option>
            <option value="S">S Tier</option>
            <option value="A">A Tier</option>
            <option value="B">B Tier</option>
        </select>
        <select id="diffFilter"><option value="">All Difficulties</option></select>
        <select id="idFilter"><option value="">All Section IDs</option></select>
    </div>
    <table id="dropTable">
        <thead>
            <tr><th>Ep</th><th>Difficulty</th><th>Map</th><th>Entity</th><th>Item Name</th><th>Rate (%)</th><th>Section ID</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="mag-tool" class="content-section">
    <div class="mag-layout">
        <div class="timer-card" id="magCard">
            <div class="mag-container sleepy" id="magBox">
                <div class="scenery"><div class="sun"></div><div class="tree"></div><div class="grass"></div></div>
                <div class="zzz-box"><div class="zzz" style="animation-delay: 0s;">Z</div><div class="zzz" style="animation-delay: 2s;">z</div></div>
                <div class="mag"></div>
            </div>
            <div id="magStatus" style="text-transform: uppercase; letter-spacing: 3px; font-size: 0.8rem; color: var(--blue); font-weight: 800;">Ready</div>
            <div id="timer-display">03:30</div>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:15px;">
                <button onclick="startMagTimer()" style="padding:10px; cursor:pointer; background:#21262d; color:var(--blue); border:1px solid var(--blue); border-radius:8px; font-weight:bold;">START CYCLE (3:30)</button>
                <button onclick="takeBreak()" style="padding:10px; cursor:pointer; background:#21262d; color:var(--green); border:1px solid var(--green); border-radius:8px; font-weight:bold;">TOUCH GRASS</button>
            </div>
        </div>
        
        <div class="timer-card" style="width: 450px; text-align: left;">
            <h3 style="color: var(--gold); margin-top: 0;">Feeding Reference</h3>
            <p style="font-size: 0.85em; opacity: 0.8;">Stat gains for common items based on archetype.</p>
            <table style="width:100%; font-size:0.8em; border-collapse:collapse;">
                <tr style="border-bottom:1px solid var(--border); color:var(--blue);"><th style="padding:5px;">Item</th><th>DEF</th><th>POW</th><th>DEX</th><th>MND</th></tr>
                <tr><td style="padding:5px;">Monomate</td><td>+5</td><td>+40</td><td>0</td><td>-5</td></tr>
                <tr><td style="padding:5px;">Monofluid</td><td>+5</td><td>-5</td><td>0</td><td>+40</td></tr>
                <tr><td style="padding:5px;">Sol Atomizer</td><td>+15</td><td>+10</td><td>+10</td><td>+10</td></tr>
            </table>
        </div>
    </div>
</div>

<script>
    const SECTION_ID_COLORS = {
        Viridia: "#22C55E", Greenill: "#16A34A", Skyly: "#38BDF8", Bluefull: "#2563EB", 
        Purplenum: "#A855F7", Pinkal: "#EC4899", Redria: "#EF4444", Oran: "#F97316", 
        Yellowboze: "#FACC15", Whitill: "#E5E7EB"
    };

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-nCzkALWoSyKOLXNORN_zgy2ONKn4Hcwi-jQNHCgmEW8DJ7yX3AyO9Uod44ecEUwklr76Dw4-p1o0/pub?gid=0&single=true&output=csv';
    let masterData = [], magTime = 210, magInterval, audioCtx;

    // --- NORMALIZATION & TIER PACK ---
    function normName(s) { return String(s || "").trim().toUpperCase().replace(/\s+/g, " "); }
    function esc(v) { return String(v ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;"); }

    const TIER_PACK = {
        globalTiers: {
            UBER: ["V101", "V502", "V801", "ADEPT", "CENTURION/ABILITY", "MOTHER GARB"],
            SPLUS: ["RED RING", "PSYCHO WAND", "DARK BRIDGE", "TSUMIKIRI J-SWORD", "DARK FLOW", "SPREAD NEEDLE", "FROZEN SHOOTER", "SNOW QUEEN", "HEAVEN PUNISHER", "HEAVEN STRIKER"],
            S: ["SEALED J-SWORD", "LAVIS CANNON", "SYNCHESTA", "SANGE & YASHA", "CHAIN SAWD", "RED SWORD", "DOUBLE CANNON", "BLACK KING BAR", "YASMINKOV 9000M", "BRINGER'S RIFLE", "HOLY RAY", "RED HANDGUN", "SUMMIT MOON", "MAGICAL PIECE", "TWINKLE STAR", "GAL WIND", "GOD/BATTLE", "GOD/ABILITY", "KASAMI BRACER", "ATTRIBUTE WALL", "STANDSTILL SHIELD"]
        },
        archetypePriority: {
            HUNTER: { SPLUS: ["TSUMIKIRI J-SWORD", "DARK FLOW", "RED RING", "GOD/BATTLE", "V101"], S: ["SEALED J-SWORD", "LAVIS CANNON"], A: ["GOD/POWER", "GOD/ARM"] },
            RANGER: { SPLUS: ["SPREAD NEEDLE", "FROZEN SHOOTER", "SNOW QUEEN", "HEAVEN PUNISHER", "HEAVEN STRIKER", "RED RING", "V101", "V502"], S: ["YASMINKOV 9000M"], A: ["GOD/ABILITY"] },
            FORCE: { SPLUS: ["PSYCHO WAND", "DARK BRIDGE", "RED RING", "V801", "ADEPT"], S: ["SUMMIT MOON", "MAGICAL PIECE"], A: ["GOD/MIND"] }
        }
    };

    const tierSets = Object.fromEntries(Object.keys(TIER_PACK.globalTiers).map(t => [t, new Set(TIER_PACK.globalTiers[t].map(normName))]));
    const archSets = Object.fromEntries(Object.keys(TIER_PACK.archetypePriority).map(a => [a, Object.fromEntries(Object.keys(TIER_PACK.archetypePriority[a]).map(p => [p, new Set(TIER_PACK.archetypePriority[a][p].map(normName))]))]));

    // --- AUDIO & NAVIGATION ---
    function playZeldaChime() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const notes = [392.00, 493.88, 587.33, 783.99], now = audioCtx.currentTime;
        notes.forEach((freq, i) => {
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now + (i * 0.1));
            gain.gain.setValueAtTime(0.1, now + (i * 0.1)); gain.gain.exponentialRampToValueAtTime(0.0001, now + (i * 0.1) + 0.4);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now + (i * 0.1)); osc.stop(now + (i * 0.1) + 0.4);
        });
    }

    function switchTab(tabId) { $('.content-section, .nav-tab').removeClass('active'); $(`#${tabId}, .nav-tab[onclick*="${tabId}"]`).addClass('active'); }

    // --- DROP TOOL LOGIC ---
    function showItemAvailability(itemName) { $('#nameSearch').val(itemName); $('#tierFilter, #diffFilter, #idFilter').val(""); applyFilters(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

    function init() {
        Papa.parse(csvUrl, { download: true, header: true, complete: function(results) {
            const sections = new Set(), diffs = new Set();
            masterData = (results.data || []).filter(r => (r.Name || "").trim()).map(row => {
                const n = normName(row.Name);
                if (row.SectionID) sections.add(String(row.SectionID).trim());
                if (row.Difficulty) diffs.add(String(row.Difficulty).trim());
                let tier = ""; for (const t in tierSets) { if (tierSets[t].has(n)) { tier = t; break; } }
                return { ...row, Tier: tier, NormName: n };
            });
            const populate = (id, set, lbl) => $(id).empty().append(`<option value="">All ${lbl}</option>`).append(Array.from(set).sort().map(v => `<option value="${v}">${v}</option>`));
            populate('#diffFilter', diffs, 'Difficulties'); populate('#idFilter', sections, 'Section IDs');
            applyFilters();
        }});
    }

    function applyFilters() {
        const name = normName($('#nameSearch').val()), tier = $('#tierFilter').val(), diff = $('#diffFilter').val(), id = $('#idFilter').val();
        renderTable(masterData.filter(r => r.NormName.includes(name) && (!tier || r.Tier === tier) && (!diff || r.Difficulty === diff) && (!id || r.SectionID === id)));
    }

    function renderTable(data) {
    const tbody = $('#dropTable tbody');
    const selected = $('#globalClassSelector').val();
    const arch = archSets[selected] || {};

    // 1. Define the Rare Enemy List
    const RARE_ENEMIES = new Set([
        "HILDEBLUE", "RAPPY", "NAR LILY", "POUILLY SLIME", 
        "MERICAR", "MERISSA AA", "PAZUZU", "DORPHON ECLAIR", "KONDRIEU"
    ]);

    tbody.empty();

    data.forEach(row => {
        const name = (row.Name || "").trim(), n = row.NormName;
        
        // 2. Normalize and check for Rare Enemy
        const entityRaw = (row.Entity || "").trim();
        const entityUpper = entityRaw.toUpperCase().replace(/_/g, " "); // Handles both Nar_Lily and Nar Lily
        const isRare = RARE_ENEMIES.has(entityUpper);
        
        // Tier and Class Value logic
        let classVal = "B VALUE";
        if (arch.SPLUS?.has(n)) classVal = "S+ VALUE"; 
        else if (arch.S?.has(n)) classVal = "S VALUE"; 
        else if (arch.A?.has(n)) classVal = "A VALUE";
        
        const pct = parseFloat(row['Current %'] || 0);
        const wikiUrl = `https://wiki.pioneer2.net/w/${encodeURIComponent(name.replace(/\s+/g, "_"))}`;
        const tierBadge = row.Tier ? `<span class="tier-tag tier-${esc(row.Tier)}">${row.Tier === "SPLUS" ? "S+" : row.Tier}</span>` : "";

        // 3. Apply Rare styling if matched
        const rareBadgeHtml = isRare ? `<span class="rare-badge">RARE</span>` : "";
        const rowHighlight = isRare ? 'class="row-rare"' : "";

        tbody.append(`<tr ${rowHighlight}>
            <td>${esc(row.Episode)}</td>
            <td><strong>${esc(row.Difficulty)}</strong></td>
            <td>${esc(row.Map)}</td>
            <td>${esc(entityRaw)} ${rareBadgeHtml}</td>
            <td>
                <div class="item-wrapper">
                    <span class="item-name-text" onclick="showItemAvailability('${esc(name)}')">${esc(name)}</span> 
                    ${tierBadge} 
                    <span class="class-val-badge">${classVal}</span>
                    <div class="hover-window">
                        <p>Class Value: ${classVal}</p>
                        <div class="rel-btn" onclick="showItemAvailability('${esc(name)}')">üîç View All Locations</div>
                        <a href="${wikiUrl}" target="_blank" class="wiki-btn">üåê View Wiki</a>
                    </div>
                </div>
            </td>
            <td>${pct >= 1 ? pct.toFixed(2) : pct.toFixed(5)}% <span style="opacity:0.6; font-size:0.8em;">(1 in ${Math.round(100/pct).toLocaleString()})</span></td>
            <td><span class="tag" data-sec="${esc(row.SectionID)}">${esc(row.SectionID)}</span></td>
        </tr>`);
    });
    applySectionIdColors();
}


    function applySectionIdColors() {
        document.querySelectorAll('.tag[data-sec]').forEach(el => {
            const color = SECTION_ID_COLORS[el.getAttribute('data-sec')] || "#30363d";
            el.style.backgroundColor = color;
            const hex = color.replace("#", "");
            const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
            el.style.color = (0.2126*r + 0.7152*g + 0.0722*b) < 140 ? "#ffffff" : "#0b0f14";
        });
    }

    // --- MAG TIMER LOGIC ---
    function startMagTimer() {
        if (!audioCtx) audioCtx = new AudioContext();
        clearInterval(magInterval); magTime = 210;
        $('#magStatus').text("DIGESTING...").css("color", "var(--blue)");
        $('#magBox').attr('class', 'mag-container sleepy'); $('body').removeClass('break-active'); $('#magCard').removeClass('break-card');
        magInterval = setInterval(() => {
            magTime--; if (magTime <= 0) { clearInterval(magInterval); playZeldaChime(); $('#magStatus').text("FEED ME!").css("color", "var(--gold)"); $('#magBox').attr('class', 'mag-container excited'); }
            updateMagDisplay();
        }, 1000);
    }

    function takeBreak() {
        clearInterval(magInterval); $('#magStatus').text("TOUCHING GRASS").css("color", "var(--green)");
        $('#magBox').attr('class', 'mag-container walking'); $('body').addClass('break-active'); $('#magCard').addClass('break-card'); $('#timer-display').text("--:--");
    }

    function updateMagDisplay() { const m = Math.floor(magTime / 60), s = magTime % 60; $('#timer-display').text(`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`); }

    $(document).ready(() => { init(); $('input, select').on('change keyup', applyFilters); });
</script>
</body>

</html>
