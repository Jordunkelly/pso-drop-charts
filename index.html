<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>PSO BB Brotherhood Drop Tool</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>

 <script>
    fetch('nav.html')
    .then(res => res.text())
    .then(data => {
        document.getElementById('nav-placeholder').innerHTML = data;
        
        // AUTOMATIC ACTIVE CLASS LOGIC
        // This detects which page you are on and highlights the correct tab
        const currentPage = window.location.pathname.split("/").pop() || "mag.html";
        const navLinks = document.querySelectorAll('.nav-link');
        
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    });
</script>
<div id="nav-placeholder"></div>

  <div class="content-section">
    <div class="controls">
      <input type="text" id="nameSearch" placeholder="Search Item..." autocomplete="off" />
      <select id="tierFilter"><option value="">All Tiers</option></select>
      <select id="diffFilter"><option value="">All Difficulties</option></select>
      <select id="idFilter"><option value="">All Section IDs</option></select>
    </div>

    <div class="table-container">
      <div id="loading">Loading Database...</div>
      <table id="dropTable" style="display:none;">
        <thead>
          <tr>
            <th data-sort="Episode">Ep</th>
            <th data-sort="Difficulty">Diff</th>
            <th data-sort="Map">Map</th>
            <th data-sort="Entity">Entity</th>
            <th data-sort="Name">Item Name</th>
            <th data-sort="Current %">Rate</th>
            <th data-sort="SectionID">ID</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
  </div>

  <script>
  /* =========================================
    LOGIC & DATA - JSON LIBRARY VERSION
   ========================================= */
    
    // --- CONFIG ---
    var SECTION_ID_COLORS = {
        Viridia: "#22C55E", Greenill: "#16A34A", Skyly: "#38BDF8", Bluefull: "#2563EB",
        Purplenum: "#A855F7", Pinkal: "#EC4899", Redria: "#EF4444", Oran: "#F97316",
        Yellowboze: "#FACC15", Whitill: "#E5E7EB"
    };
    
    // URL for your new exported JSON file
    var jsonUrl = "pso_drop_table_export.json"; 
    // Your Tier List remains a CSV for now
    var tierUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-nCzkALWoSyKOLXNORN_zgy2ONKn4Hcwi-jQNHCgmEW8DJ7yX3AyO9Uod44ecEUwklr76Dw4-p1o0/pub?gid=292779988&single=true&output=csv";
    
    var masterData = [];
    var globalTierMap = new Map();
    var currentSort = { col: null, dir: 'asc' };
    
    // --- INIT ---
    $(document).ready(function() {
        // 1. Load Tier List First
        Papa.parse(tierUrl, {
            download: true,
            header: true,
            complete: function(results) {
                (results.data || []).forEach(function(row) {
                    if (row["ITEM NAME"]) {
                        globalTierMap.set(row["ITEM NAME"].trim().toUpperCase(), row["TIER RANK"]);
                    }
                });
                // 2. Load the Library JSON
                fetchDropData();
            }
        });
    });
    
    function fetchDropData() {
        fetch(jsonUrl)
            .then(response => response.json())
            .then(jsonData => {
                processNestedJson(jsonData);
            })
            .catch(err => {
                console.error(err);
                $("#loading").text("Error loading JSON database. Check file path.");
            });
    }
    
    // --- FLATTEN NESTED JSON ---
    function processNestedJson(root) {
        var tiers = new Set(), diffs = new Set(), ids = new Set();
        var flattened = [];
    
        // Navigate: Normal -> Episode -> Difficulty -> Section -> Entity
        const base = root.Normal;
    
        for (let epKey in base) {
            for (let diffKey in base[epKey]) {
                for (let secKey in base[epKey][diffKey]) {
                    let entities = base[epKey][diffKey][secKey];
    
                    for (let entName in entities) {
                        let dropData = entities[entName];
    
                        // Handle standard vs multi-drop (condensed) logic
                        let dropList = Array.isArray(dropData[0]) ? dropData : [dropData];
    
                        dropList.forEach(drop => {
                            let fraction = drop[0];
                            let hexId = drop[1];
    
                            // Mapping for the UI
                            let itemName = entName; // Note: You may want a Hex-to-Name map later
                            let nameUpper = itemName.toUpperCase();
                            let tier = globalTierMap.get(nameUpper) || "";
    
                            if (tier) tiers.add(tier);
                            diffs.add(diffKey);
                            ids.add(secKey);
    
                            flattened.push({
                                Episode: epKey.replace("Episode", ""),
                                Difficulty: diffKey,
                                SectionID: secKey,
                                Entity: entName,
                                Name: itemName,
                                HexId: hexId,
                                "Rate_Raw": fraction, // e.g., "1/8192"
                                _nameUpper: nameUpper,
                                _tier: tier,
                                _diff: diffKey,
                                _id: secKey
                            });
                        });
                    }
                }
            }
        }
    
        masterData = flattened;
    
        // Populate UI filters
        populateSelect("#tierFilter", Array.from(tiers).sort(), "Tier");
        populateSelect("#diffFilter", ["Normal", "Hard", "Very Hard", "Ultimate"], "Diff", true);
        populateSelect("#idFilter", Array.from(ids).sort(), "ID");
    
        $("#loading").hide();
        $("#dropTable").fadeIn();
        applyFilters();
    }
    
    // --- RENDER TABLE ---
    function renderTable(data) {
        var $tbody = $("#dropTable tbody").empty();
        var RARE_MOBS = ["HILDEBLUE", "NAR LILY", "POUILLY SLIME", "AL RAPPY", "PAL RAPPY", "MIL LILY", "KONDRIEU"];
        var limit = 200; 
        
        data.slice(0, limit).forEach(function(r) {
            // Calculate Rate from Fraction (e.g., "1/8192")
            let rate = 0;
            if (r.Rate_Raw.includes('/')) {
                let parts = r.Rate_Raw.split('/');
                rate = (parseInt(parts[0]) / parseInt(parts[1])) * 100;
            } else {
                rate = parseFloat(r.Rate_Raw);
            }
    
            var dispRate = (rate > 1) ? rate.toFixed(1) + "%" : rate.toFixed(6) + "%";
            var odds = (rate > 0) ? (100 / rate) : 0;
            var dispOdds = (odds > 10) ? Math.round(odds).toLocaleString() : odds.toFixed(2);
    
            var isRare = RARE_MOBS.some(x => r.Entity.toUpperCase().includes(x));
            var tierHtml = r._tier ? `<span class="tier-tag tier-${r._tier.toLowerCase()}">${r._tier}</span>` : "";
            var idColor = SECTION_ID_COLORS[r._id] || "#555";
    
            var row = `
                <tr class="${isRare ? 'row-rare' : ''}">
                    <td>${r.Episode}</td>
                    <td>${r.Difficulty}</td>
                    <td>${r.SectionID}</td>
                    <td>${r.Entity}</td>
                    <td><a href="#" class="wiki-link">${r.Name}</a> ${tierHtml}</td>
                    <td>${dispRate}<br><small style="opacity:0.6">1/${dispOdds}</small></td>
                    <td><span class="tag" style="background:${idColor};">${r.SectionID}</span></td>
                </tr>
            `;
            $tbody.append(row);
        });
    
        if (data.length === 0) $tbody.append('<tr><td colspan="7">No drops found.</td></tr>');
    }
  </script>
</body>
</html>




