<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PSO BB Brotherhood Drop Tool</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="nav-placeholder"></div>

  <div class="content-section">
    <div class="controls">
      <input type="text" id="nameSearch" placeholder="Search Item Name..." />
      <select id="tierFilter"><option value="">All Tiers</option></select>
      <select id="diffFilter"><option value="">All Diffs</option></select>
      <select id="idFilter"><option value="">All IDs</option></select>
    </div>

    <div class="table-container">
      <table id="dropTable">
        <thead>
          <tr>
            <th class="col-ep">Ep</th>
            <th>Diff</th>
            <th class="col-map">Map</th>
            <th>Entity</th>
            <th>Item Name</th>
            <th>Rate &amp; Odds</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    (function loadNav() {
      fetch("nav.html")
        .then(function (res) { return res.text(); })
        .then(function (data) {
          var holder = document.getElementById("nav-placeholder");
          if (!holder) return;
          holder.innerHTML = data;

          var currentPage = window.location.pathname.split("/").pop() || "index.html";
          var navLinks = document.querySelectorAll(".nav-link");
          navLinks.forEach(function (link) {
            if (link.getAttribute("href") === currentPage) link.classList.add("active");
          });
        })
        .catch(function () {});
    })();

    var SECTION_ID_COLORS = {
      Viridia: "#22C55E",
      Greenill: "#16A34A",
      Skyly: "#38BDF8",
      Bluefull: "#2563EB",
      Purplenum: "#A855F7",
      Pinkal: "#EC4899",
      Redria: "#EF4444",
      Oran: "#F97316",
      Yellowboze: "#FACC15",
      Whitill: "#E5E7EB"
    };

    var csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-nCzkALWoSyKOLXNORN_zgy2ONKn4Hcwi-jQNHCgmEW8DJ7yX3AyO9Uod44ecEUwklr76Dw4-p1o0/pub?gid=0&single=true&output=csv";
    var tierTableUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-nCzkALWoSyKOLXNORN_zgy2ONKn4Hcwi-jQNHCgmEW8DJ7yX3AyO9Uod44ecEUwklr76Dw4-p1o0/pub?gid=292779988&single=true&output=csv";

    var masterData = [];
    var globalTierMap = new Map();
    var tierModMap = new Map();

    function normName(s) {
      return String(s || "").trim().toUpperCase().replace(/\s+/g, " ");
    }

    function esc(v) {
      return String(v ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function init() {
      Papa.parse(tierTableUrl, {
        download: true,
        header: true,
        complete: function (tierResults) {
          (tierResults.data || []).forEach(function (row) {
            var name = normName(row["ITEM NAME"]);
            if (!name) return;
            globalTierMap.set(name, row["TIER RANK"]);
            tierModMap.set(name, parseInt(row["TIER MOD"], 10) || 0);
          });
          fetchDropData();
        }
      });
    }

    function fetchDropData() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function (results) {
          var sections = new Set();
          var diffs = new Set();
          var tiers = new Set();

          masterData = (results.data || [])
            .filter(function (r) { return (r.Name || "").trim(); })
            .map(function (row) {
              var n = normName(row.Name);
              if (row.SectionID) sections.add(row.SectionID.trim());
              if (row.Difficulty) diffs.add(row.Difficulty.trim());
              var tier = globalTierMap.get(n) || "";
              if (tier) tiers.add(tier);
              return Object.assign({}, row, { NormName: n, Tier: tier });
            });

          var diffOrder = ["Normal", "Hard", "Very Hard", "Ultimate"];
          var sortedDiffs = Array.from(diffs).sort(function (a, b) {
            return diffOrder.indexOf(a.trim()) - diffOrder.indexOf(b.trim());
          });

          populateSelect("#tierFilter", Array.from(tiers).sort(), "Tiers");
          populateSelect("#diffFilter", sortedDiffs, "Diffs");
          populateSelect("#idFilter", Array.from(sections).sort(), "IDs");
          applyFilters();
        }
      });
    }

    function populateSelect(id, values, label) {
      $(id).empty().append('<option value="">All ' + label + "</option>");
      values.forEach(function (v) {
        var displayName = (v === "U") ? "UBER" : v;
        $(id).append('<option value="' + v + '">' + displayName + "</option>");
      });
    }

    function applyFilters() {
      var name = normName($("#nameSearch").val());
      var tier = $("#tierFilter").val();
      var diff = $("#diffFilter").val();
      var id = $("#idFilter").val();

      var filtered = masterData.filter(function (r) {
        var okName = r.NormName.includes(name);
        var okTier = (!tier || r.Tier === tier);
        var okDiff = (!diff || r.Difficulty === diff);
        var okId = (!id || r.SectionID === id);
        return okName && okTier && okDiff && okId;
      });

      renderTable(filtered);
    }

    function renderTable(data) {
      var tbody = $("#dropTable tbody");
      var RARE_ENEMIES = new Set([
        "HILDEBLUE", "RAPPY", "NAR LILY", "POUILLY SLIME", 
        "MERICAR", "MERISSA AA", "PAZUZU", "DORPHON ECLAIR", "KONDRIEU"
      ]);
      tbody.empty();
    
      data.forEach(function (row) {
        var nameStr = (row.Name || "").trim();
        var n = row.NormName;
        var entRaw = (row.Entity || "").trim();
        var isRare = RARE_ENEMIES.has(entRaw.toUpperCase().replace(/_/g, " "));
    
        // 1. Get the Raw String directly from CSV to display exactly what you see in the sheet
        var rawPctStr = row["Current %"] || "0";
        var pct = parseFloat(rawPctStr);
        
        // 2. Logic for Display & Odds
        // If > 1, it's a Percentage (e.g. 87.5). Add "%" and calc odds as 100/pct.
        // If <= 1, it's a Raw Probability (e.g. 0.0078125). Show raw number and calc odds as 1/pct.
        var pctText = "";
        var oddsVal = 0;

        if (pct > 1) {
            pctText = rawPctStr + "%"; 
            oddsVal = 100 / pct;
        } else {
            pctText = rawPctStr; // Read it raw (no %)
            oddsVal = (pct > 0) ? (1 / pct) : 0;
        }

        var odds = (pct > 0) ? "1 in " + Math.round(oddsVal).toLocaleString() : "N/A";
    
        var rawTier = row.Tier ? row.Tier.trim() : "";
        var tierBadge = rawTier ? '<span class="tier-tag tier-' + rawTier.toLowerCase() + '">' + esc(rawTier) + "</span>" : "";
    
        var wikiSlug = encodeURIComponent(nameStr.replace(/\s+/g, "_"));
        var wikiUrl = "https://wiki.pioneer2.net/w/" + wikiSlug;
    
        var section = (row.SectionID || "").trim();
        var bg = SECTION_ID_COLORS[section] || "#333";
    
        tbody.append(
          '<tr class="' + (isRare ? "row-rare" : "") + '">' +
            '<td class="col-ep" data-label="Ep">' + esc(row.Episode) + "</td>" +
            '<td data-label="Diff"><strong>' + esc(row.Difficulty) + "</strong></td>" +
            '<td class="col-map" data-label="Map">' + esc(row.Map) + "</td>" +
            '<td data-label="Entity">' + esc(entRaw) + (isRare ? ' <span class="rare-badge">R</span>' : "") + "</td>" +
            '<td data-label="Item">' +
              '<a href="' + wikiUrl + '" target="_blank" class="wiki-link">' + esc(nameStr) + "</a>" +
              tierBadge +
            "</td>" +
            '<td data-label="Rate">' + pctText + ' <br><small style="opacity:0.6">' + esc(odds) + "</small></td>" +
            '<td data-label="ID"><span class="tag" style="background:' + bg + '">' + esc(section) + "</span></td>" +
          "</tr>"
        );
      });
    }
    
    $(document).ready(init);
    $(document).on("change keyup", "input, select", applyFilters);
  </script>
</body>
</html>




