<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSO Photon Defender</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --bg: #010409;
            --fg: #c9d1d9;
            --primary: #58a6ff;
            --secondary: #facc15;
            --danger: #d8616f;
            --hunter: #f97316;
            --ranger: #22c55e;
            --force: #a855f7;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            overscroll-behavior: none; 
        }

        .game-world-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 10px;
            box-sizing: border-box;
            min-height: calc(100vh - 60px); 
        }

        h1 {
            color: var(--primary);
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }

        #gamePanel {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        canvas {
            background: #161b22;
            border: 4px solid #30363d;
            border-radius: 8px;
            width: 100%;
            height: auto;
            max-height: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            touch-action: none; 
        }

        /* Screen Shake */
        @keyframes damage-shake {
            0% { transform: translate(0, 0); border-color: #ef4444; }
            20% { transform: translate(-10px, 0); border-color: #ef4444; }
            40% { transform: translate(10px, 0); border-color: #ef4444; }
            60% { transform: translate(-10px, 0); border-color: #ef4444; }
            80% { transform: translate(10px, 0); border-color: #ef4444; }
            100% { transform: translate(0, 0); border-color: #30363d; }
        }
        .shake-effect { animation: damage-shake 0.4s; }

        /* Notifications */
        #boss-warning {
            display: none;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            text-align: center;
            animation: flash 0.5s infinite alternate;
            z-index: 10;
        }
        @keyframes flash { from { opacity: 1; } to { opacity: 0; } }

        /* Rare Notification */
        #rare-notification {
            display: none;
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 0 20px #ff0000;
            text-align: center;
            z-index: 20;
            pointer-events: none;
            animation: rarePulse 0.5s infinite alternate;
        }
        @keyframes rarePulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.2); } }

        /* Damage Text Float */
        .dmg-float {
            position: absolute;
            color: #facc15;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 15;
        }
        @keyframes floatUp { from { transform: translateY(0); opacity:1; } to { transform: translateY(-30px); opacity:0; } }

        .hud {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            color: var(--fg);
            font-family: 'Courier New', monospace;
            margin-top: 12px;
            font-size: 0.9rem;
            background: rgba(48, 54, 61, 0.5);
            padding: 10px;
            border-radius: 4px;
            gap: 10px;
        }

        .controls-area {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #classSelect {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .button {
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            background: #161b22;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
            text-transform: uppercase;
            text-align: center;
            width: 100%;
        }
        .button:hover, .button:active { background: var(--primary); color: #fff; }

        .btn-hunter { border-color: var(--hunter); color: var(--hunter); }
        .btn-hunter:hover { background: var(--hunter); color: #fff; }
        
        .btn-ranger { border-color: var(--ranger); color: var(--ranger); }
        .btn-ranger:hover { background: var(--ranger); color: #fff; }
        
        .btn-force { border-color: var(--force); color: var(--force); }
        .btn-force:hover { background: var(--force); color: #fff; }

        #scoreForm { display: none; flex-direction: row; gap: 10px; }
        #playerName {
            flex: 1;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        #leaderboard {
            display: none;
            margin-top: 15px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
        }
        .lb-title { color: var(--secondary); font-weight: bold; text-align: center; margin-bottom: 5px; }
        .lb-row { display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid #30363d; padding: 4px 0; }
        .lb-row:last-child { border-bottom: none; }
        .lb-name { color: var(--primary); font-weight: bold;}
        .lb-class { text-align: center; font-size: 0.8em; text-transform: uppercase; }
        .lb-score { color: #fff; text-align: right; }
        
        .c-hunter { color: var(--hunter); }
        .c-ranger { color: var(--ranger); }
        .c-force  { color: var(--force); }

        .mobile-hint {
            display: none;
            text-align: center;
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 5px;
        }
        @media (pointer: coarse) { .mobile-hint { display: block; } }
    </style>
</head>
<body>

    <div id="nav-placeholder"></div>

    <div class="game-world-wrapper">
        <h1>PSO Photon Defender</h1>
        
        <div id="gamePanel">
            <div id="boss-warning">WARNING<br>BOSS APPROACHING</div>
            <div id="rare-notification">RARE DROP ACQUIRED!</div>
            <div id="dmg-container"></div>
            <canvas id="canvas" width="900" height="500"></canvas>
            
            <div class="hud">
                <div>
                    SCORE: <span id="score">0</span>
                    &nbsp;|&nbsp; LVL: <span id="level">1</span>
                    &nbsp;|&nbsp; <span id="dmg-mult" style="color:#facc15; font-weight:bold;">DMG: x1.00</span>
                </div>
                <div>
                    SYNC: 
                    <span id="sync-bar" style="display:inline-block;width:80px;height:10px;background:#30363d;vertical-align:middle;border-radius:2px;overflow:hidden; margin-right:10px;">
                        <span id="sync-fill" style="display:block;height:100%;background:#eab308;width:100%;"></span>
                    </span>
                    MAG: 
                    <span id="blast-bar" style="display:inline-block;width:80px;height:10px;background:#30363d;vertical-align:middle;border-radius:2px;overflow:hidden;">
                        <span id="blast-fill" style="display:block;height:100%;background:var(--primary);width:0%;"></span>
                    </span>
                </div>
            </div>
            
            <div class="controls-area">
                
                <div id="classSelect">
                    <button class="button btn-hunter" onclick="startGame('hunter')">
                        HUNTER<br><span style="font-size:0.7em">Wave Attack<br>5 Lives</span>
                    </button>
                    <button class="button btn-ranger" onclick="startGame('ranger')">
                        RANGER<br><span style="font-size:0.7em">Bullet Hell<br>Fast Speed</span>
                    </button>
                    <button class="button btn-force" onclick="startGame('force')">
                        FORCE<br><span style="font-size:0.7em">Homing Techs<br>1 Life</span>
                    </button>
                </div>

                <button id="retryBtn" class="button" style="display:none">TRY AGAIN</button>

                <div id="scoreForm">
                    <input type="text" id="playerName" placeholder="ENTER NAME" maxlength="10">
                    <button id="submitScoreBtn" class="button" style="width:auto; background:#238636; border-color:#238636; color:white;">SUBMIT SCORE</button>
                </div>

                <div id="leaderboard">
                    <div class="lb-title">--- TOP HUNTERS ---</div>
                    <div id="lb-content">Loading...</div>
                </div>
            </div>

            <div class="mobile-hint">Touch & Drag to Move â€¢ Double Tap to Blast</div>
        </div>
    </div>

    <script>
        // CONFIG
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6T_nPSiK2jQIyWI09Jgcf2g8q9F_6JENVPWoaGbWoft2xIGOCJpnbehX2VJwGXpc/exec"; 

        fetch('nav.html')
            .then(res => res.text())
            .then(data => {
                const holder = document.getElementById('nav-placeholder');
                if(holder) holder.innerHTML = data;
                const link = document.querySelector('a[href="booma.html"]');
                if (link) link.classList.add('active');
            }).catch(e => console.log("Nav not found"));

        class Game {
            constructor(canvas, playerClass) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = canvas.width;
                this.height = canvas.height;
                this.running = false;
                this.playerClass = playerClass || 'hunter'; 
                
                // Base Player Config
                this.player = {
                    x: 50, y: this.height / 2 - 20, w: 40, h: 40,
                    dy: 0, dx: 0, // Enable horizontal movement
                    speed: 5, lives: 3, invincible: 0,
                    weaponLevel: 1, 
                    syncTimer: 1000, 
                    maxSync: 1000,
                    shootInterval: 12,
                    damageMultiplier: 1.0,
                    rareTimer: 0 
                };

                // Class Stats
                if (this.playerClass === 'hunter') {
                    this.player.lives = 5; 
                    this.player.speed = 5;
                    this.magRate = 1.0;
                    this.player.damage = 0.8;
                } else if (this.playerClass === 'ranger') {
                    this.player.lives = 3;
                    this.player.speed = 8;
                    this.magRate = 1.0;
                    this.player.damage = 0.5;
                } else if (this.playerClass === 'force') {
                    // MAGE NERF: Glass Cannon
                    this.player.lives = 1; 
                    this.player.speed = 3; 
                    this.magRate = 2.0; 
                    this.player.shootInterval = 25; 
                    this.player.damage = 0.4; 
                }

                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('psoHighScore') || '0', 10);
                this.level = 1;
                this.frame = 0;
                this.spawnRate = 60;
                
                this.bullets = [];
                this.enemies = [];
                this.powerUps = [];
                this.enemyBullets = [];
                this.blastEnergy = 0;
                
                this.bossSpawnedForLevel = false;
                this.input = { up: false, down: false, left: false, right: false, shoot: false, blast: false };
                this.lastTouchEnd = 0;
                this.isTouchActive = false;
                
                this.sounds = {
                    shoot: (freq = 880) => this.playSfx(freq, 'square', 0.08, 0.05),
                    hit: () => this.playSfx(440, 'square', 0.1),
                    explode: () => this.playSfx(220, 'sawtooth', 0.3),
                    power: () => this.playSfx(620, 'triangle', 0.2),
                    blast: () => this.playSfx(110, 'sine', 0.5, 0.2),
                    warning: () => this.playSfx(150, 'sawtooth', 0.8, 0.2),
                    levelup: () => this.playSfx(880, 'triangle', 0.5, 0.2),
                    powerdown: () => this.playSfx(150, 'square', 0.5, 0.2),
                    rare: () => this.playSfx(1200, 'square', 1.0, 0.3)
                };

                this.initInputs();
            }

            initInputs() {
                window.addEventListener('keydown', (e) => {
                    if (!this.running) return;
                    if (e.code === 'ArrowUp' || e.code === 'KeyW') this.input.up = true;
                    if (e.code === 'ArrowDown' || e.code === 'KeyS') this.input.down = true;
                    if (e.code === 'ArrowLeft' || e.code === 'KeyA') this.input.left = true;
                    if (e.code === 'ArrowRight' || e.code === 'KeyD') this.input.right = true;
                    if (e.code === 'Space') this.input.shoot = true;
                    if (e.code === 'ShiftLeft' || e.code === 'KeyX') this.input.blast = true;
                });
                window.addEventListener('keyup', (e) => {
                    if (!this.running) return;
                    if (e.code === 'ArrowUp' || e.code === 'KeyW') this.input.up = false;
                    if (e.code === 'ArrowDown' || e.code === 'KeyS') this.input.down = false;
                    if (e.code === 'ArrowLeft' || e.code === 'KeyA') this.input.left = false;
                    if (e.code === 'ArrowRight' || e.code === 'KeyD') this.input.right = false;
                    if (e.code === 'Space') this.input.shoot = false;
                    if (e.code === 'ShiftLeft' || e.code === 'KeyX') this.input.blast = false;
                });

                const getTouchPos = (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const scaleY = this.canvas.height / rect.height; 
                    const scaleX = this.canvas.width / rect.width;
                    return { 
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY 
                    };
                };

                this.canvas.addEventListener('touchstart', (e) => {
                    if (!this.running) return;
                    e.preventDefault(); 
                    this.isTouchActive = true;
                    this.input.shoot = true; 
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - this.lastTouchEnd;
                    if (tapLength < 300 && tapLength > 0) this.triggerBlast();
                    this.lastTouchEnd = currentTime;
                    const pos = getTouchPos(e);
                    this.handleTouchMove(pos.x, pos.y);
                }, {passive: false});

                this.canvas.addEventListener('touchmove', (e) => {
                    if (!this.running) return;
                    e.preventDefault();
                    const pos = getTouchPos(e);
                    this.handleTouchMove(pos.x, pos.y);
                }, {passive: false});

                this.canvas.addEventListener('touchend', (e) => {
                    if (!this.running) return;
                    e.preventDefault();
                    if (e.touches.length === 0) {
                        this.isTouchActive = false;
                        this.input.shoot = false;
                        this.player.dy = 0;
                        this.player.dx = 0;
                    }
                }, {passive: false});
            }

            handleTouchMove(xPos, yPos) {
                this.player.y = yPos - (this.player.h / 2);
                this.player.x = xPos - (this.player.w / 2);
            }

            triggerBlast() {
                if (this.blastEnergy >= 100) {
                    this.input.blast = true;
                    setTimeout(() => this.input.blast = false, 200);
                }
            }

            start() {
                this.running = true;
                this.loop();
            }

            loop() {
                if (!this.running) return;
                this.update();
                this.render();
                requestAnimationFrame(() => this.loop());
            }

            spawnBossSequence(name, type, color) {
                this.bossSpawnedForLevel = true;
                const warning = document.getElementById('boss-warning');
                if(warning) warning.style.display = 'block';
                if(warning) warning.innerHTML = `WARNING<br>${name.toUpperCase()}`;
                
                this.sounds.warning();
                this.enemies = []; 
                setTimeout(() => {
                    if(warning) warning.style.display = 'none';
                    let baseHp = 800;
                    if (type === 'dragon' && this.level === 5) baseHp = 1500; 
                    let hp = baseHp + (this.level * 250);

                    let boss = { 
                        type: type, isBoss: true, x: this.width + 100, y: this.height/2 - 75,
                        w: 150, h: 150, 
                        hp: hp, maxHp: hp, 
                        speed: 2, color: color, canShoot: true, shotTimer: 60 
                    };
                    this.enemies.push(boss);
                }, 3000);
            }

            update() {
                this.frame++;
                if (this.frame % 1500 === 0) { 
                    this.level++;
                    this.spawnRate = Math.max(15, this.spawnRate - 5);
                    this.bossSpawnedForLevel = false; 
                }

                if (!this.bossSpawnedForLevel) {
                    if (this.level === 5) this.spawnBossSequence('Dragon', 'dragon', '#eab308');
                    else if (this.level === 10) this.spawnBossSequence('De Rol Le', 'derolle', '#a855f7'); 
                    else if (this.level === 15) this.spawnBossSequence('Vol Opt', 'volopt', '#ef4444');
                    else if (this.level === 20) this.spawnBossSequence('Dark Falz', 'falz', '#c084fc');
                }

                // Rare Timer
                if (this.player.rareTimer > 0) {
                    this.player.rareTimer--;
                    if (this.player.rareTimer === 0) {
                        const rareNotif = document.getElementById('rare-notification');
                        if(rareNotif) rareNotif.style.display = 'none';
                    } else if (this.playerClass === 'force' && this.player.rareTimer % 15 === 0) {
                        if(this.enemies.length > 0) {
                            let target = this.enemies[Math.floor(Math.random() * this.enemies.length)];
                            this.bullets.push({ 
                                x: target.x, y: target.y - 100, 
                                w: 20, h: 100, s: 0, 
                                piercing: true, homing: false, life: 10,
                                isGrants: true 
                            });
                        }
                    }
                }

                // Sync Timer
                if (this.player.syncTimer > 0) {
                    this.player.syncTimer--;
                } else {
                    if (this.player.weaponLevel > 1) {
                        this.player.weaponLevel--;
                        this.player.syncTimer = this.player.maxSync;
                        this.sounds.powerdown();
                        if (this.player.weaponLevel < 10) this.player.damageMultiplier = 1.0;
                    }
                }

                if (!this.isTouchActive) {
                    if (this.input.up) this.player.dy = -this.player.speed;
                    else if (this.input.down) this.player.dy = this.player.speed;
                    else this.player.dy = 0;
                    this.player.y += this.player.dy;

                    // X Movement
                    if (this.input.left) this.player.dx = -this.player.speed;
                    else if (this.input.right) this.player.dx = this.player.speed;
                    else this.player.dx = 0;
                    this.player.x += this.player.dx;
                }
                
                // Screen Bounds
                this.player.y = Math.max(0, Math.min(this.height - this.player.h, this.player.y));
                this.player.x = Math.max(0, Math.min(this.width - this.player.w, this.player.x));

                let shootRate = this.player.shootInterval;
                if (this.player.rareTimer > 0 && this.playerClass === 'ranger') shootRate = 2; 

                if (this.input.shoot && this.frame % shootRate === 0) this.shoot();
                if (this.input.blast && this.blastEnergy >= 100) this.photonBlast();

                let isBossActive = this.enemies.some(e => e.isBoss);
                if (!isBossActive && this.frame % this.spawnRate === 0) this.spawnEnemy();
                if (this.frame % 600 === 0) this.spawnPowerUp();

                this.bullets.forEach((b, i) => {
                    if (b.isGrants) {
                        b.y += 20; 
                    } else {
                        b.x += b.s;
                        if (b.homing) {
                            let nearest = null;
                            let minDist = 9999;
                            this.enemies.forEach(e => {
                                let dist = Math.hypot(e.x - b.x, e.y - b.y);
                                if (dist < minDist && e.x > b.x) { 
                                    minDist = dist;
                                    nearest = e;
                                }
                            });
                            if (nearest) {
                                // Turn Rate Limit
                                let dy = nearest.y - b.y;
                                let turnSpeed = 1.5; 
                                if (Math.abs(dy) < turnSpeed) b.y += dy;
                                else b.y += Math.sign(dy) * turnSpeed;
                            }
                        }
                    }

                    if (b.x > this.width || b.x < 0 || b.y < 0 || b.y > this.height) {
                        this.bullets.splice(i, 1);
                    } else if (b.life && --b.life <= 0) {
                        this.bullets.splice(i, 1);
                    }
                });

                this.enemies.forEach((e, i) => {
                    if (e.isBoss) {
                        if (e.x > this.width - e.w - 20) {
                            e.x -= e.speed;
                        } else {
                            e.x = (this.width - e.w - 20) + Math.sin(this.frame / 70) * 40;
                        }
                        let sweepRange = (this.height - 100);
                        e.y = (this.height/2 - e.h/2) + Math.sin(this.frame / 60) * (sweepRange / 2);
                    } else {
                        e.x -= e.speed;
                        if (e.type === 'sinow') e.y += Math.sin(this.frame / 10) * e.speed;
                    }
                    if (this.checkCollision(e, this.player) && this.player.invincible <= 0) {
                        if (this.player.rareTimer > 0 && this.playerClass === 'hunter') {
                            // Invincible
                        } else {
                            this.takeHit();
                            if (!e.isBoss) { this.enemies.splice(i, 1); return; }
                        }
                    }
                    if (e.x + e.w < 0) this.enemies.splice(i, 1);
                    if (e.canShoot) {
                        e.shotTimer--;
                        if (e.shotTimer <= 0) {
                            this.spawnEnemyBullet(e);
                            e.shotTimer = (e.isBoss ? 20 : 90) + Math.random() * 20;
                        }
                    }
                });

                this.powerUps.forEach((p, i) => {
                    p.x -= p.speed;
                    if (this.checkCollision(p, this.player)) {
                        this.applyPowerUp(p);
                        this.powerUps.splice(i, 1);
                        return;
                    }
                    if (p.x + p.w < 0) this.powerUps.splice(i, 1);
                });

                this.bullets.forEach((b, bi) => {
                    this.enemies.forEach((e, ei) => {
                        if (this.checkCollision(b, e)) {
                            let baseDmg = (this.playerClass === 'ranger') ? 0.5 : (this.playerClass === 'force' ? 0.4 : 0.8);
                            let dmg = baseDmg * this.player.damageMultiplier;
                            
                            if (this.player.rareTimer > 0) {
                                if (this.playerClass === 'hunter') dmg = 10; 
                                if (this.playerClass === 'force') dmg = 5; 
                            }

                            e.hp -= dmg;
                            this.sounds.hit();
                            if (!b.piercing) this.bullets.splice(bi, 1);
                            if (e.hp <= 0) {
                                this.killEnemy(e);
                                this.enemies.splice(ei, 1);
                            }
                        }
                    });
                });

                if (this.player.weaponType === 'laser') {
                    const beamY1 = this.player.y + this.player.h * 0.25;
                    const beamY2 = this.player.y + this.player.h * 0.75;
                    this.enemies.forEach((e, ei) => {
                        if (e.x + e.w > this.player.x + this.player.w && e.y < beamY2 && e.y + e.h > beamY1) {
                            e.hp -= (0.5 * this.player.damageMultiplier);
                            if (e.hp <= 0) { this.killEnemy(e); this.enemies.splice(ei, 1); }
                        }
                    });
                }

                this.enemyBullets.forEach((eb, ei) => {
                    eb.x -= (eb.vx || eb.s || 0);
                    eb.y += (eb.vy || 0);
                    if (this.checkCollision(eb, this.player) && this.player.invincible <= 0) {
                        if (!(this.player.rareTimer > 0 && this.playerClass === 'hunter')) {
                            this.takeHit();
                            this.enemyBullets.splice(ei, 1);
                            return;
                        }
                    }
                    if (eb.x + eb.w < 0 || eb.y + eb.h < 0 || eb.y > this.height) this.enemyBullets.splice(ei, 1);
                });

                if (this.player.invincible > 0) this.player.invincible--;
                
                // --- SAFELY UPDATE HUD ---
                const scoreEl = document.getElementById('score');
                if(scoreEl) scoreEl.textContent = this.score;
                
                const lvlEl = document.getElementById('level');
                if(lvlEl) lvlEl.textContent = this.player.weaponLevel >= 10 ? "10 (MAX)" : this.player.weaponLevel;
                
                const dmgEl = document.getElementById('dmg-mult');
                if(dmgEl) dmgEl.textContent = "DMG: x" + this.player.damageMultiplier.toFixed(2);
                
                const livesEl = document.getElementById('lives');
                if(livesEl) livesEl.textContent = this.player.lives;
                
                const blastEl = document.getElementById('blast-fill');
                if(blastEl) blastEl.style.width = Math.min(this.blastEnergy, 100) + '%';
                
                const syncEl = document.getElementById('sync-fill');
                if(syncEl) {
                    let syncPct = (this.player.syncTimer / this.player.maxSync) * 100;
                    syncEl.style.width = syncPct + '%';
                }
            }

            render() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.width, this.height);
                ctx.fillStyle = '#0a0e1a';
                ctx.fillRect(0, 0, this.width, this.height);
                
                ctx.save();
                if (this.player.invincible > 0 && Math.floor(this.frame / 5) % 2 === 0) ctx.globalAlpha = 0.5;
                
                if (this.playerClass === 'hunter') ctx.fillStyle = '#f97316';
                else if (this.playerClass === 'ranger') ctx.fillStyle = '#22c55e';
                else ctx.fillStyle = '#a855f7';

                if (this.player.rareTimer > 0) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#ef4444'; 
                }

                ctx.beginPath();
                ctx.moveTo(this.player.x, this.player.y + this.player.h / 2);
                ctx.lineTo(this.player.x + this.player.w, this.player.y);
                ctx.lineTo(this.player.x + this.player.w, this.player.y + this.player.h);
                ctx.closePath();
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 0; 
                let dots = Math.min(10, this.player.weaponLevel);
                for(let i=0; i<dots; i++) {
                    ctx.fillRect(this.player.x + (i*4), this.player.y + this.player.h + 5, 3, 3);
                }
                ctx.restore();

                ctx.fillStyle = '#58a6ff';
                this.bullets.forEach(b => {
                    if (b.isGrants) {
                        ctx.fillStyle = '#facc15'; 
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                    } else {
                        ctx.fillStyle = '#58a6ff';
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                    }
                });

                this.enemies.forEach(e => {
                    ctx.fillStyle = e.color;
                    ctx.fillRect(e.x, e.y, e.w, e.h);
                    ctx.fillStyle = '#262b31';
                    ctx.fillRect(e.x, e.y - 10, e.w, 6);
                    ctx.fillStyle = e.isBoss ? '#ef4444' : '#68c896';
                    ctx.fillRect(e.x, e.y - 10, e.w * (e.hp / e.maxHp), 6);
                });

                this.powerUps.forEach(p => {
                    ctx.fillStyle = p.color;
                    if (p.type === 'rare') {
                        ctx.shadowBlur = 15;
                        ctx.shadowColor = '#ef4444';
                        ctx.fillRect(p.x, p.y, p.w, p.h);
                        ctx.shadowBlur = 0;
                    } else {
                        ctx.beginPath();
                        ctx.arc(p.x + p.w / 2, p.y + p.h / 2, p.w / 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });

                this.enemyBullets.forEach(eb => {
                    ctx.fillStyle = eb.color || '#f87171';
                    ctx.fillRect(eb.x, eb.y, eb.w, eb.h);
                });
            }

            shoot() {
                this.sounds.shoot();
                let offsets = [0];
                let bulletProps = { w: 12, h: 4, s: 8, piercing: false, homing: false, life: 999 };
                const lvl = this.player.weaponLevel;

                if (this.player.rareTimer > 0) {
                    if (this.playerClass === 'hunter') {
                        bulletProps.w = 300; bulletProps.h = 400; bulletProps.s = 15; bulletProps.piercing = true;
                        offsets = [0];
                    } 
                    else if (this.playerClass === 'ranger') {
                        for(let i=0; i<20; i++) {
                            offsets = [-100,-80,-60,-40,-20,0,20,40,60,80,100];
                        }
                    }
                    else if (this.playerClass === 'force') {
                        return; 
                    }
                } else {
                    if (this.playerClass === 'hunter') {
                        bulletProps.w = 10; bulletProps.h = 40 + (lvl * 5); bulletProps.s = 7; bulletProps.life = 60; 
                        if (lvl >= 4) offsets = [-20, 20];
                        if (lvl >= 7) offsets = [-30, 0, 30]; 
                        if (lvl >= 10) { bulletProps.h = 100; bulletProps.piercing = true; }
                    } 
                    else if (this.playerClass === 'ranger') {
                        bulletProps.w = 15; bulletProps.h = 3; bulletProps.s = 15; 
                        if (lvl >= 4) offsets = [-10, 10]; 
                        if (lvl >= 7) offsets = [-20, -10, 0, 10, 20]; 
                        if (lvl >= 10) offsets = [-30,-20,-10,0,10,20,30]; 
                    }
                    else if (this.playerClass === 'force') {
                        bulletProps.w = 8; bulletProps.h = 8; bulletProps.s = 5; bulletProps.homing = true;
                        if (lvl >= 4) offsets = [-10, 10]; 
                        if (lvl >= 7) offsets = [-20, 0, 20]; 
                        if (lvl >= 10) { bulletProps.s = 12; offsets = [-30,-15,15,30]; } 
                    }
                }

                if (this.player.weaponType === 'spread') offsets = [-20, -10, 0, 10, 20];
                if (this.player.weaponType === 'pierce') bulletProps.piercing = true;
                if (this.player.weaponType === 'laser') return; 

                offsets.forEach(offsetY => {
                    this.bullets.push({ 
                        x: this.player.x + this.player.w, 
                        y: this.player.y + this.player.h / 2 - (bulletProps.h/2) + offsetY, 
                        w: bulletProps.w, h: bulletProps.h, s: bulletProps.s, 
                        piercing: bulletProps.piercing, homing: bulletProps.homing, life: bulletProps.life
                    });
                });
            }

            photonBlast() {
                this.sounds.blast();
                this.blastEnergy = 0;
                this.enemies.forEach(e => { e.hp -= 50; if(e.hp <= 0) this.killEnemy(e, true); });
                this.enemies = this.enemies.filter(e => e.hp > 0);
            }

            spawnEnemy() {
                const types = ['rappy','booma','sinow'];
                if (this.level >= 2 && Math.random() < 0.1) types.push('baranz');
                const type = types[Math.floor(Math.random() * types.length)];
                let e = { type: type, x: this.width, canShoot: false };
                
                if (type === 'rappy') Object.assign(e, { y: Math.random()*(this.height-40), w: 36, h: 36, hp: 1, maxHp: 1, speed: 3, color: '#facc15' });
                else if (type === 'booma') Object.assign(e, { y: Math.random()*(this.height-50), w: 42, h: 42, hp: 2, maxHp: 2, speed: 2.5, color: '#2ea043' });
                else if (type === 'sinow') Object.assign(e, { y: Math.random()*(this.height-60), w: 50, h: 50, hp: 3, maxHp: 3, speed: 3.5, color: '#c084fc', canShoot: true });
                else if (type === 'baranz') Object.assign(e, { y: Math.random()*(this.height-120), w: 80, h: 80, hp: 8, maxHp: 8, speed: 1.5, color: '#ef4444', canShoot: true });
                this.enemies.push(e);
            }

            spawnPowerUp() {
                const rand = Math.random();
                let type = 'weapondata';
                let color = '#f97316'; 

                if (rand < 0.01) { type = 'rare'; color = '#ef4444'; } 
                else if (rand < 0.2) { type = 'heal'; color = '#34d399'; }
                else if (rand < 0.3) { type = 'blast'; color = '#f472b6'; }
                
                let size = (type === 'rare') ? 30 : 24;
                this.powerUps.push({ x: this.width, y: Math.random()*(this.height-30), w: size, h: size, type: type, speed: 2, color: color });
            }

            applyPowerUp(p) {
                this.player.syncTimer = this.player.maxSync;

                if (p.type === 'rare') {
                    this.player.rareTimer = 3600; 
                    document.getElementById('rare-notification').style.display = 'block';
                    this.sounds.rare();
                    this.player.lives = Math.max(this.player.lives, 5);
                }
                else if (p.type === 'weapondata') {
                    if (this.player.weaponLevel < 10) {
                        this.player.weaponLevel++;
                        this.sounds.levelup();
                    } else {
                        this.player.damageMultiplier += 0.1;
                        this.showFloatText("+DMG!", this.player.x, this.player.y);
                        this.sounds.power();
                    }
                }
                else if (p.type === 'heal') this.player.lives = Math.min(10, this.player.lives + 1);
                else if (p.type === 'blast') this.blastEnergy = Math.min(100, this.blastEnergy + 50);
                
                if (p.type !== 'rare' && p.type !== 'weapondata') this.sounds.power();
            }

            showFloatText(text, x, y) {
                const el = document.createElement('div');
                el.className = 'dmg-float';
                el.innerText = text;
                el.style.left = (this.canvas.offsetLeft + x) + 'px';
                el.style.top = (this.canvas.offsetTop + y) + 'px';
                document.getElementById('dmg-container').appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }

            spawnEnemyBullet(e) {
                const b = [];
                if (e.type === 'sinow') {
                    b.push({ x: e.x, y: e.y+e.h/2-5, w: 10, h: 4, vx: 7, vy: 0, color: '#f87171' });
                    b.push({ x: e.x, y: e.y+e.h/2+5, w: 10, h: 4, vx: 7, vy: 0, color: '#f87171' });
                }
                else if (e.type === 'baranz') [-2,0,2].forEach(vy => b.push({ x: e.x, y: e.y+e.h/2-3, w: 14, h: 6, vx: 6, vy: vy, color: '#ef4444' }));
                else if (e.type === 'dragon') {
                    b.push({ x: e.x, y: e.y+e.h/2-10, w: 40, h: 20, vx: 10, vy: 0, color: '#ff7b72' });
                    b.push({ x: e.x, y: e.y+e.h/2+10, w: 40, h: 20, vx: 10, vy: 0, color: '#ff7b72' });
                }
                else if (e.type === 'derolle') [-4,-2, 0, 2, 4].forEach(vy => b.push({ x: e.x, y: e.y+e.h/2, w: 20, h: 20, vx: 6, vy: vy, color: '#a855f7' }));
                else if (e.type === 'volopt') { b.push({ x: e.x, y: e.y+20, w: 30, h: 6, vx: 13, vy: 0, color: '#ef4444' }); b.push({ x: e.x, y: e.y+e.h-20, w: 30, h: 6, vx: 13, vy: 0, color: '#ef4444' }); }
                else if (e.type === 'falz') { for(let i=0; i<16; i++) { let angle = (i / 16) * Math.PI * 2; b.push({ x: e.x + e.w/2, y: e.y + e.h/2, w: 15, h: 15, vx: Math.cos(angle)*5 - 2, vy: Math.sin(angle)*5, color: '#e2e8f0' }); } }
                b.forEach(bullet => this.enemyBullets.push(bullet));
            }

            killEnemy(e, fromBlast=false) {
                this.sounds.explode();
                this.score += e.maxHp * 10;
                if (!fromBlast) this.blastEnergy = Math.min(100, this.blastEnergy + (e.maxHp * 0.5 * this.magRate)); 
                if (Math.random() < 0.1) this.spawnPowerUp();
            }

            takeHit() {
                this.sounds.explode();
                this.player.lives--;
                this.player.invincible = 120;
                if(this.player.weaponLevel > 1) this.player.weaponLevel--;
                
                document.getElementById('canvas').classList.add('shake-effect');
                setTimeout(() => document.getElementById('canvas').classList.remove('shake-effect'), 400);
                if (this.player.lives <= 0) this.gameOver();
            }

            gameOver() {
                this.running = false;
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('psoHighScore', this.score.toString());
                }
                const ctx = this.ctx;
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(0,0,this.width,this.height);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 40px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('GAME OVER', this.width/2, this.height/2 - 40);
                ctx.font = '20px Courier New';
                ctx.fillText('FINAL SCORE: ' + this.score, this.width/2, this.height/2);
                ctx.fillText('HIGH SCORE: ' + this.highScore, this.width/2, this.height/2 + 30);
                
                document.getElementById('retryBtn').style.display = 'block';
                document.getElementById('scoreForm').style.display = 'flex';
                document.getElementById('leaderboard').style.display = 'block';
                
                this.fetchHighScores();
            }

            fetchHighScores() {
                const lbContent = document.getElementById('lb-content');
                if(!lbContent) return;
                lbContent.innerHTML = "Loading...";
                
                fetch(SCRIPT_URL + "?action=get", { mode: 'cors' })
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        lbContent.innerHTML = "<div style='text-align:center; padding:10px;'>No scores yet. Be the first!</div>";
                        return;
                    }
                    let html = "";
                    data.forEach(entry => {
                        let cClass = entry.charClass ? entry.charClass.toLowerCase() : 'unknown';
                        html += `
                        <div class="lb-row">
                            <span class="lb-name">${entry.name.substring(0, 10)}</span>
                            <span class="lb-class c-${cClass}">${cClass.charAt(0).toUpperCase() + cClass.slice(1)}</span>
                            <span class="lb-score">${entry.score}</span>
                        </div>`;
                    });
                    lbContent.innerHTML = html;
                })
                .catch(err => {
                    lbContent.innerHTML = "Error loading scores.";
                    console.error(err);
                });
            }

            checkCollision(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

            playSfx(freq, type, dur, vol = 0.1) {
                try {
                    if (!window.audioCtx) window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = window.audioCtx.createOscillator();
                    const gain = window.audioCtx.createGain();
                    osc.type = type; osc.frequency.setValueAtTime(freq, window.audioCtx.currentTime);
                    gain.gain.setValueAtTime(vol, window.audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, window.audioCtx.currentTime + dur);
                    osc.connect(gain); gain.connect(window.audioCtx.destination);
                    osc.start(); osc.stop(window.audioCtx.currentTime + dur);
                } catch(e) {}
            }
        }

        const canvas = document.getElementById('canvas');
        let game = null;

        function startGame(className) {
            document.getElementById('classSelect').style.display = 'none';
            document.getElementById('scoreForm').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'none';
            
            game = new Game(canvas, className);
            game.start();
        }

        document.getElementById('retryBtn').addEventListener('click', () => {
            document.getElementById('retryBtn').style.display = 'none';
            document.getElementById('scoreForm').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
            
            document.getElementById('classSelect').style.display = 'grid';
            
            const submitBtn = document.getElementById('submitScoreBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = "SUBMIT SCORE";
        });

        document.getElementById('submitScoreBtn').addEventListener('click', () => {
            const name = document.getElementById('playerName').value.trim().toUpperCase();
            if(!name) { alert("ENTER NAME FIRST"); return; }
            if(!game) return;

            const btn = document.getElementById('submitScoreBtn');
            btn.textContent = "SENDING...";
            btn.disabled = true;

            const targetUrl = `${SCRIPT_URL}?name=${encodeURIComponent(name)}&score=${game.score}&level=${game.level}&class=${game.playerClass}`;

            fetch(targetUrl, { method: 'GET', mode: 'no-cors' })
            .then(() => {
                alert("SCORE UPLOADED!");
                btn.textContent = "SENT!";
                game.fetchHighScores(); 
            }).catch(e => {
                console.error(e);
                alert("ERROR UPLOADING");
                btn.textContent = "RETRY";
                btn.disabled = false;
            });
        });

    </script>
</body>
</html>
