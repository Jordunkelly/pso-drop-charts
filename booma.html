<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSO Photon Defender</title>
    <link rel="stylesheet" href="style.css">
    <!--
        This copy of the original Photon Defender has been modified to address
        gameplay feedback. The most notable changes are:

        - Weapon evolution now caps at ten levels. Once maxed out, additional
          weapon pickups add to a separate damage multiplier which is shown in
          the HUD. A floating indicator notifies players whenever the
          multiplier increases, rewarding consecutive pickups.

        - Boss encounters are more varied. Each boss now comes with its own
          behaviours and attack patterns to differentiate the fights and make
          them feel unique. See spawnBossSequence and spawnEnemyBullet for
          details.

        - Classes have been rebalanced. Each class retains a unique strength
          but weaknesses are smoothed out. Hunters deal the most damage,
          Rangers excel at rapid crowd control, and Forces gain homing attacks
          and a time‑slow ability during boss fights when upgraded.

        - Additional HUD elements and floating text surface upgrades and
          multipliers to the player in real time.
    -->
    <style>
        :root {
            --bg: #010409;
            --fg: #c9d1d9;
            --primary: #58a6ff;
            --secondary: #facc15;
            --danger: #d8616f;
            --hunter: #f97316;
            --ranger: #22c55e;
            --force: #a855f7;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        .game-world-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 10px;
            box-sizing: border-box;
            min-height: calc(100vh - 60px);
        }
        h1 {
            color: var(--primary);
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }
        #gamePanel {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        canvas {
            background: #161b22;
            border: 4px solid #30363d;
            border-radius: 8px;
            width: 100%;
            height: auto;
            max-height: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            touch-action: none;
        }
        /* Screen Shake */
        @keyframes damage-shake {
            0% { transform: translate(0, 0); border-color: #ef4444; }
            20% { transform: translate(-10px, 0); border-color: #ef4444; }
            40% { transform: translate(10px, 0); border-color: #ef4444; }
            60% { transform: translate(-10px, 0); border-color: #ef4444; }
            80% { transform: translate(10px, 0); border-color: #ef4444; }
            100% { transform: translate(0, 0); border-color: #30363d; }
        }
        .shake-effect { animation: damage-shake 0.4s; }
        /* Notifications */
        #boss-warning {
            display: none;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            text-align: center;
            animation: flash 0.5s infinite alternate;
            z-index: 10;
        }
        @keyframes flash { from { opacity: 1; } to { opacity: 0; } }
        /* Rare Notification */
        #rare-notification {
            display: none;
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 0 20px #ff0000;
            text-align: center;
            z-index: 20;
            pointer-events: none;
            animation: rarePulse 0.5s infinite alternate;
        }
        @keyframes rarePulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.2); } }
        /* Damage Text Float */
        .dmg-float {
            position: absolute;
            color: #facc15;
            font-weight: bold;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px #000;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            z-index: 15;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity:1; }
            100% { transform: translateY(-50px) scale(1.5); opacity:0; }
        }
        .hud {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            color: var(--fg);
            font-family: 'Courier New', monospace;
            margin-top: 12px;
            font-size: 0.9rem;
            background: rgba(48, 54, 61, 0.5);
            padding: 10px;
            border-radius: 4px;
            gap: 10px;
        }
        .controls-area {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #classSelect {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .button {
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            background: #161b22;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
            text-transform: uppercase;
            text-align: center;
            width: 100%;
        }
        .button:hover, .button:active { background: var(--primary); color: #fff; }
        .btn-hunter { border-color: var(--hunter); color: var(--hunter); }
        .btn-hunter:hover { background: var(--hunter); color: #fff; }
        .btn-ranger { border-color: var(--ranger); color: var(--ranger); }
        .btn-ranger:hover { background: var(--ranger); color: #fff; }
        .btn-force { border-color: var(--force); color: var(--force); }
        .btn-force:hover { background: var(--force); color: #fff; }
        #scoreForm { display: none; flex-direction: row; gap: 10px; }
        #playerName {
            flex: 1;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        #leaderboard {
            display: none;
            margin-top: 15px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
        }
        .lb-title { color: var(--secondary); font-weight: bold; text-align: center; margin-bottom: 5px; }
        .lb-row { display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid #30363d; padding: 4px 0; }
        .lb-row:last-child { border-bottom: none; }
        .lb-name { color: var(--primary); font-weight: bold;}
        .lb-class { text-align: center; font-size: 0.8em; text-transform: uppercase; }
        .lb-score { color: #fff; text-align: right; }
        .c-hunter { color: var(--hunter); }
        .c-ranger { color: var(--ranger); }
        .c-force  { color: var(--force); }
        .mobile-hint {
            display: none;
            text-align: center;
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 5px;
        }
        @media (pointer: coarse) { .mobile-hint { display: block; } }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>
    <div class="game-world-wrapper">
        <h1>PSO Photon Defender</h1>
        <div id="gamePanel">
            <div id="boss-warning">WARNING<br>BOSS APPROACHING</div>
            <div id="rare-notification">RARE DROP ACQUIRED!</div>
            <div id="dmg-container"></div>
            <canvas id="canvas" width="900" height="500"></canvas>
            <div class="hud">
                <div>
                    SCORE: <span id="score">0</span>
                    &nbsp;|&nbsp; LVL: <span id="level">1</span>
                    &nbsp;|&nbsp; LIVES: <span id="lives">0</span>
                    &nbsp;|&nbsp; <span id="dmg-mult" style="color:#facc15; font-weight:bold;">DMG: x1.00</span>
                    <!-- Display the current weapon or tech for the player.  This helps convey class builds and makes upgrades more obvious. -->
                    &nbsp;|&nbsp; <span id="weapon-info" style="color:#58a6ff; font-weight:bold;">---</span>
                </div>
                <div>
                    SYNC:
                    <span id="sync-bar" style="display:inline-block;width:80px;height:10px;background:#30363d;vertical-align:middle;border-radius:2px;overflow:hidden; margin-right:10px;">
                        <span id="sync-fill" style="display:block;height:100%;background:#eab308;width:100%;"></span>
                    </span>
                    MAG:
                    <span id="blast-bar" style="display:inline-block;width:80px;height:10px;background:#30363d;vertical-align:middle;border-radius:2px;overflow:hidden;">
                        <span id="blast-fill" style="display:block;height:100%;background:var(--primary);width:0%;"></span>
                    </span>
                </div>
            </div>
            <div class="controls-area">
                <div id="classSelect">
                    <button class="button btn-hunter" onclick="startGame('hunter')">
                        HUNTER<br><span style="font-size:0.7em">Wave Attack<br>Tank: 7 Lives</span>
                    </button>
                    <button class="button btn-ranger" onclick="startGame('ranger')">
                        RANGER<br><span style="font-size:0.7em">Multiple Guns<br>Very Fast</span>
                    </button>
                    <button class="button btn-force" onclick="startGame('force')">
                        FORCE<br><span style="font-size:0.7em">Elemental Techs<br>2 Lives</span>
                    </button>
                </div>
                <button id="retryBtn" class="button" style="display:none">TRY AGAIN</button>
                <div id="scoreForm">
                    <input type="text" id="playerName" placeholder="ENTER NAME" maxlength="10">
                    <button id="submitScoreBtn" class="button" style="width:auto; background:#238636; border-color:#238636; color:white;">SUBMIT SCORE</button>
                </div>
                <div id="leaderboard">
                    <div class="lb-title">--- TOP HUNTERS ---</div>
                    <div id="lb-content">Loading...</div>
                </div>
            </div>
            <div class="mobile-hint">Touch & Drag to Move • Double Tap to Blast</div>
        </div>
    </div>
    <script>
       const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6T_nPSiK2jQIyWI09Jgcf2g8q9F_6JENVPWoaGbWoft2xIGOCJpnbehX2VJwGXpc/exec";

// Visual Asset Preloading (Placeholder colors if images fail)
const areaBackgroundImg = new Image();
areaBackgroundImg.src = 'areas_background.png';
const areaCoords = { forest: { sx: 0, sy: 0 }, caves: { sx: 768, sy: 0 }, mines: { sx: 0, sy: 512 }, ruins: { sx: 768, sy: 512 } };

const enemyData = {
    rappy: { w: 36, h: 36, hp: 1, speed: 3, color: '#facc15', canShoot: true, shootFreq: 120 },
    booma: { w: 42, h: 42, hp: 3, speed: 2, color: '#2ea043', canShoot: false },
    sinow: { w: 50, h: 50, hp: 5, speed: 3.5, color: '#c084fc', canShoot: true, shootFreq: 90 },
    hildebear: { w: 80, h: 80, hp: 15, speed: 1.5, color: '#78350f', canShoot: true, isElite: true, shootFreq: 150 },
    baranz: { w: 75, h: 75, hp: 20, speed: 1.2, color: '#ef4444', canShoot: true, isElite: true, shootFreq: 180 }
};

class Game {
    constructor(canvas, playerClass) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.width = canvas.width;
        this.height = canvas.height;
        this.running = false;
        this.playerClass = playerClass || 'hunter';
        
        this.player = {
            x: 50, y: this.height / 2 - 20, w: 40, h: 40,
            speed: playerClass === 'ranger' ? 8 : 5,
            lives: playerClass === 'hunter' ? 7 : (playerClass === 'force' ? 2 : 4),
            weaponLevel: 1, syncTimer: 1000, maxSync: 1000,
            damageMultiplier: 1.0, invincible: 0,
            weaponType: playerClass === 'hunter' ? 'saber' : (playerClass === 'force' ? 'tech' : 'handgun'),
            element: 'fire'
        };

        this.score = 0; this.level = 1; this.frame = 0;
        this.bullets = []; this.enemies = []; this.enemyBullets = []; this.powerUps = [];
        this.area = 'forest';
        this.input = {};
        this.initInputs();
    }

    initInputs() {
        window.onkeydown = (e) => this.input[e.code] = true;
        window.onkeyup = (e) => this.input[e.code] = false;
    }

    start() { this.running = true; this.loop(); }

    loop() {
        if (!this.running) return;
        this.update();
        this.render();
        requestAnimationFrame(() => this.loop());
    }

    update() {
        this.frame++;
        // Movement
        if (this.input['ArrowUp'] || this.input['KeyW']) this.player.y -= this.player.speed;
        if (this.input['ArrowDown'] || this.input['KeyS']) this.player.y += this.player.speed;
        if (this.input['ArrowLeft'] || this.input['KeyA']) this.player.x -= this.player.speed;
        if (this.input['ArrowRight'] || this.input['KeyD']) this.player.x += this.player.speed;

        this.player.y = Math.max(0, Math.min(this.height - this.player.h, this.player.y));
        this.player.x = Math.max(0, Math.min(this.width * 0.4, this.player.x));

        // Difficulty Curve
        this.level = Math.floor(this.score / 2500) + 1;
        this.area = this.level < 5 ? 'forest' : (this.level < 10 ? 'caves' : (this.level < 15 ? 'mines' : 'ruins'));

        // Spawning
        if (this.frame % Math.max(20, 60 - this.level * 2) === 0) this.spawnEnemy();
        if (this.input['Space'] && this.frame % 15 === 0) this.shoot();

        // Projectile Logic
        this.bullets.forEach((b, i) => {
            b.x += b.s; b.y += (b.vy || 0);
            if (b.homing && this.enemies.length > 0) {
                let target = this.enemies[0];
                if (target.y > b.y) b.y += 2; else b.y -= 2;
            }
            if (b.x > this.width) this.bullets.splice(i, 1);
        });

        this.enemies.forEach((e, i) => {
            e.x -= e.speed + (this.level * 0.1);
            
            // Elite Telegraph Logic
            if (e.canShoot) {
                e.shootTimer = (e.shootTimer || 0) + 1;
                if (e.shootTimer > e.shootFreq - 30) e.telegraphing = true;
                if (e.shootTimer >= e.shootFreq) {
                    this.enemyShoot(e);
                    e.shootTimer = 0;
                    e.telegraphing = false;
                }
            }

            if (this.checkCollision(this.player, e)) this.takeHit();
            if (e.x < -100) this.enemies.splice(i, 1);
        });

        this.enemyBullets.forEach((eb, i) => {
            eb.x += eb.vx; eb.y += eb.vy;
            if (this.checkCollision(this.player, eb)) this.takeHit();
            if (eb.x < 0 || eb.x > this.width) this.enemyBullets.splice(i, 1);
        });

        // Collision: Player Bullets -> Enemies
        this.bullets.forEach((b, bi) => {
            this.enemies.forEach((e, ei) => {
                if (this.checkCollision(b, e)) {
                    e.hp -= this.player.damageMultiplier * (this.playerClass === 'hunter' ? 2 : 1);
                    if (!b.piercing) this.bullets.splice(bi, 1);
                    if (e.hp <= 0) this.killEnemy(e, ei);
                }
            });
        });

        this.updateHUD();
    }

    render() {
        const ctx = this.ctx;
        ctx.fillStyle = this.level < 5 ? '#052e16' : '#0e2433';
        ctx.fillRect(0, 0, this.width, this.height);

        // Render Player
        ctx.save();
        if (this.player.invincible > 0 && Math.floor(this.frame / 5) % 2 === 0) ctx.globalAlpha = 0.3;
        ctx.fillStyle = this.playerClass === 'hunter' ? '#f97316' : (this.playerClass === 'force' ? '#a855f7' : '#22c55e');
        ctx.fillRect(this.player.x, this.player.y, this.player.w, this.player.h);
        ctx.restore();

        // Render Bullets with UNIQUE ANIMATIONS
        this.bullets.forEach(b => {
            ctx.save();
            ctx.shadowBlur = 10; ctx.shadowColor = b.color || '#fff';
            if (this.playerClass === 'hunter') {
                // Readble Melee Arcs
                ctx.strokeStyle = b.color || '#f97316';
                ctx.lineWidth = 4 + this.player.weaponLevel;
                ctx.beginPath();
                ctx.arc(b.x, b.y, 30 + this.player.weaponLevel * 3, -0.5, 0.5);
                ctx.stroke();
            } else {
                ctx.fillStyle = b.color || '#fff';
                ctx.fillRect(b.x, b.y, b.w, b.h);
            }
            ctx.restore();
        });

        // Render Enemies & Telegraphs
        this.enemies.forEach(e => {
            if (e.telegraphing) {
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 3;
                ctx.strokeRect(e.x - 5, e.y - 5, e.w + 10, e.h + 10);
            }
            ctx.fillStyle = e.color;
            ctx.fillRect(e.x, e.y, e.w, e.h);
        });

        this.enemyBullets.forEach(eb => {
            ctx.fillStyle = '#ff4444';
            ctx.fillRect(eb.x, eb.y, eb.w, eb.h);
        });
    }

    shoot() {
        const lvl = this.player.weaponLevel;
        let b = { x: this.player.x + 40, y: this.player.y + 15, w: 10, h: 4, s: 10, piercing: false, color: '#58a6ff' };

        if (this.playerClass === 'hunter') {
            b.w = 20; b.h = 40; b.piercing = true; b.s = 8;
        } else if (this.playerClass === 'force') {
            b.homing = true; b.color = '#a855f7';
        } else if (this.playerClass === 'ranger') {
            b.s = 15; b.color = '#22c55e';
            if (lvl > 5) this.bullets.push({...b, vy: 1}, {...b, vy: -1});
        }
        this.bullets.push(b);
    }

    enemyShoot(e) {
        const speed = 4 + (this.level * 0.2);
        const angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
        
        if (e.isElite) {
            // Bullet Hell Cross
            for(let i=0; i<4; i++) {
                let a = angle + (i * Math.PI / 2);
                this.enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(a)*speed, vy: Math.sin(a)*speed, w: 10, h: 10 });
            }
        } else {
            this.enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, w: 8, h: 8 });
        }
    }

    spawnEnemy() {
        const keys = Object.keys(enemyData);
        const type = keys[Math.floor(Math.random() * keys.length)];
        const def = enemyData[type];
        this.enemies.push({ ...def, x: this.width, y: Math.random() * (this.height - def.h), maxHp: def.hp });
    }

    killEnemy(e, index) {
        this.score += e.isElite ? 500 : 100;
        this.enemies.splice(index, 1);
        if (this.player.weaponLevel < 10 && (e.isElite || Math.random() < 0.2)) {
            this.player.weaponLevel++;
            this.showFloatText("LVL UP!", this.player.x, this.player.y);
        }
    }

    takeHit() {
        if (this.player.invincible > 0) return;
        this.player.lives--;
        this.player.invincible = 90;
        if (this.player.lives <= 0) {
            this.running = false;
            alert("Mission Failed. Score: " + this.score);
            location.reload();
        }
    }

    checkCollision(a, b) {
        return a.x < b.x + (b.w || 10) && a.x + (a.w || 10) > b.x && a.y < b.y + (b.h || 10) && a.y + (a.h || 10) > b.y;
    }

    updateHUD() {
        document.getElementById('score').innerText = this.score;
        document.getElementById('lives').innerText = this.player.lives;
        document.getElementById('level').innerText = this.level;
        document.getElementById('weapon-info').innerText = `${this.player.weaponType.toUpperCase()} L${this.player.weaponLevel}`;
    }

    showFloatText(text, x, y) {
        const el = document.createElement('div');
        el.className = 'dmg-float';
        el.innerText = text;
        el.style.left = (this.canvas.offsetLeft + x) + 'px';
        el.style.top = (this.canvas.offsetTop + y) + 'px';
        document.getElementById('dmg-container').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    playSfx(freq, type, dur) {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        } catch(e) {}
    }
}

let game;
function startGame(pClass) {
    document.getElementById('classSelect').style.display = 'none';
    game = new Game(document.getElementById('canvas'), pClass);
    game.start();
}
    </script>
</body>
</html>
